name: Build Patched Dual (Release + Preview) and Publish

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  libcore:
    name: Native Build (LibCore)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Golang Status
        run: find buildScript libcore/*.sh | xargs cat | sha1sum > golang_status

      - name: Libcore Status
        run: git ls-files libcore | xargs cat | sha1sum > libcore_status

      - name: LibCore Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            app/libs/libcore.aar
          key: ${{ hashFiles('.github/workflows/*', 'golang_status', 'libcore_status') }}

      - name: Install Golang
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25

      - name: Native Build
        if: steps.cache.outputs.cache-hit != 'true'
        run: ./run lib core

  build_and_publish:
    name: Build Dual APKs (Signed) + Publish Release
    runs-on: ubuntu-latest
    needs: [libcore]
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Restore LibCore Cache
        uses: actions/cache@v4
        with:
          path: |
            app/libs/libcore.aar
          key: ${{ hashFiles('.github/workflows/*', 'golang_status', 'libcore_status') }}

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle
          key: gradle-oss-${{ hashFiles('**/*.gradle.kts') }}

      - name: Prepare signing keystore (PKCS12)
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.SIGNING_KEYSTORE_B64 }}" | base64 -d > signing.p12
          ls -lah signing.p12

      - name: Validate keystore (fail fast)
        shell: bash
        run: |
          set -euo pipefail
          keytool -list -v \
            -keystore signing.p12 \
            -storetype PKCS12 \
            -storepass "${{ secrets.SIGNING_KEYSTORE_PASSWORD }}" \
            -alias "${{ secrets.SIGNING_KEY_ALIAS }}" >/dev/null
          echo "Keystore OK (alias exists)."

      - name: Init Gradle (project scripts)
        env:
          BUILD_PLUGIN: none
        shell: bash
        run: |
          set -euo pipefail
          echo "sdk.dir=${ANDROID_HOME}" > local.properties
          echo "ndk.dir=${ANDROID_HOME}/ndk/25.0.8775105" >> local.properties
          export LOCAL_PROPERTIES="${{ secrets.LOCAL_PROPERTIES }}"
          ./run init action gradle

      - name: Build (PreviewRelease + OssRelease)
        env:
          BUILD_PLUGIN: none
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew app:assemblePreviewRelease app:assembleOssRelease

      - name: Sign APKs -> dist/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          BUILD_TOOLS="$(ls -d ${ANDROID_HOME}/build-tools/* | sort -V | tail -n 1)"
          APKSIGNER="${BUILD_TOOLS}/apksigner"
          echo "Using build-tools: ${BUILD_TOOLS}"

          sign_one() {
            local in_apk="$1"
            local base="$(basename "$in_apk")"
            local out_apk="dist/${base%.apk}-signed.apk"

            echo "Signing: $in_apk"
            "${APKSIGNER}" sign \
              --ks signing.p12 \
              --ks-type PKCS12 \
              --ks-pass "pass:${{ secrets.SIGNING_KEYSTORE_PASSWORD }}" \
              --ks-key-alias "${{ secrets.SIGNING_KEY_ALIAS }}" \
              --key-pass "pass:${{ secrets.SIGNING_KEY_PASSWORD }}" \
              --out "$out_apk" \
              "$in_apk"

            "${APKSIGNER}" verify --verbose "$out_apk" >/dev/null
          }

          SIGNED_COUNT=0

          # 1) Preview release outputs
          if [ -d "app/build/outputs/apk/preview/release" ]; then
            while IFS= read -r apk; do
              [ -f "$apk" ] || continue
              sign_one "$apk"
              SIGNED_COUNT=$((SIGNED_COUNT+1))
            done < <(find app/build/outputs/apk/preview/release -type f -name "*.apk" | sort)
          else
            echo "WARN: preview/release output dir not found"
          fi

          # 2) OSS stable release outputs
          if [ -d "app/build/outputs/apk/oss/release" ]; then
            while IFS= read -r apk; do
              [ -f "$apk" ] || continue
              sign_one "$apk"
              SIGNED_COUNT=$((SIGNED_COUNT+1))
            done < <(find app/build/outputs/apk/oss/release -type f -name "*.apk" | sort)
          else
            echo "WARN: oss/release output dir not found"
          fi

          echo "Signed count = $SIGNED_COUNT"
          ls -lah dist || true

          if [ "$SIGNED_COUNT" -eq 0 ]; then
            echo "ERROR: No APKs signed. dist is empty."
            echo "DEBUG: list app/build/outputs/apk:"
            find app/build/outputs/apk -maxdepth 6 -type f -name "*.apk" -print || true
            exit 1
          fi

      - name: Compute release tag/title (China time) + include upstream tag
        id: rel
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM_TAG="unknown"
          if [ -f ".upstream_release_tag" ]; then
            UPSTREAM_TAG="$(cat .upstream_release_tag | tr -d '\r\n')"
          fi

          TS="$(TZ=Asia/Shanghai date +%Y%m%d-%H%M)"
          TAG="patched-${UPSTREAM_TAG}+build-${TS}"
          TITLE="Patched ${UPSTREAM_TAG} (${TS} CST)"

          echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Publish GitHub Release + upload dist/*.apk
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ steps.rel.outputs.tag }}"
          TITLE="${{ steps.rel.outputs.title }}"
          UPSTREAM="${{ steps.rel.outputs.upstream_tag }}"
          COMMIT="$(git rev-parse --short HEAD)"

          NOTES_FILE="$(mktemp)"
          {
            echo "Upstream: ${UPSTREAM}"
            echo "Patched branch: patched-release"
            echo "Commit: ${COMMIT}"
            echo ""
            echo "Artifacts:"
            echo "- Preview (signed)"
            echo "- OSS Stable (signed)"
          } > "${NOTES_FILE}"

          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release exists, will upload with --clobber: ${TAG}"
          else
            gh release create "${TAG}" -t "${TITLE}" -F "${NOTES_FILE}"
          fi

          gh release upload "${TAG}" dist/*.apk --clobber

      - name: Also upload as workflow artifacts (optional backup)
        uses: actions/upload-artifact@v4
        with:
          name: APKs-signed
          path: dist/*.apk
