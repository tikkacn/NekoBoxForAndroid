name: Build Dual APKs (Signed) + Publish Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  libcore:
    name: Native Build (LibCore)
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Install Golang
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25

      - name: Build libcore.aar
        run: |
          set -euo pipefail
          ./run lib core
          test -f app/libs/libcore.aar
          ls -lah app/libs/libcore.aar

      - name: Upload libcore.aar
        uses: actions/upload-artifact@v4
        with:
          name: libcore-aar
          path: app/libs/libcore.aar

  build:
    name: Build Dual APKs + Sign + Release
    runs-on: ubuntu-latest
    needs: [libcore]
    env:
      TZ: Asia/Shanghai
      BUILD_PLUGIN: none
      KSTORE_TYPE: PKCS12
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Download libcore.aar
        uses: actions/download-artifact@v4
        with:
          name: libcore-aar
          path: app/libs

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Init Gradle (project scripts)
        run: |
          set -euo pipefail
          echo "sdk.dir=${ANDROID_HOME}" > local.properties
          echo "ndk.dir=${ANDROID_HOME}/ndk/25.0.8775105" >> local.properties
          export LOCAL_PROPERTIES="${{ secrets.LOCAL_PROPERTIES }}"
          ./run init action gradle

      - name: Build (PreviewRelease + OssRelease)
        run: |
          set -euo pipefail
          ./gradlew app:assemblePreviewRelease app:assembleOssRelease

      - name: Prepare signing keystore
        env:
          SIGNING_KEYSTORE_B64: ${{ secrets.SIGNING_KEYSTORE_B64 }}
        run: |
          set -euo pipefail
          test -n "${SIGNING_KEYSTORE_B64}"
          echo "${SIGNING_KEYSTORE_B64}" | base64 -d > signing.p12
          ls -lah signing.p12

      - name: Validate keystore (fail fast)
        env:
          STOREPASS: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
        run: |
          set -euo pipefail
          test -n "${STOREPASS}"
          test -n "${ALIAS}"
          keytool -list -keystore signing.p12 -storetype "${KSTORE_TYPE}" -storepass "${STOREPASS}" -alias "${ALIAS}" >/dev/null
          echo "Keystore OK."

      - name: Sign APKs -> dist/
        env:
          STOREPASS: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          KEYPASS: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: |
          set -euo pipefail

          UPSTREAM_TAG=""
          if [ -f .upstream_release_tag ]; then
            UPSTREAM_TAG=$(tr -d '\r\n\t ' < .upstream_release_tag)
          fi
          if [ -z "${UPSTREAM_TAG}" ]; then
            UPSTREAM_TAG=$(git describe --tags --abbrev=0 || true)
          fi
          test -n "${UPSTREAM_TAG}"

          BUILD_TS=$(date +'%Y%m%d-%H%M')
          echo "UPSTREAM_TAG=${UPSTREAM_TAG}" >> $GITHUB_ENV
          echo "BUILD_TS=${BUILD_TS}" >> $GITHUB_ENV

          BUILD_TOOLS="$(ls -d ${ANDROID_HOME}/build-tools/* | sort -V | tail -n 1)"
          APKSIGNER="${BUILD_TOOLS}/apksigner"
          echo "Using build-tools: ${BUILD_TOOLS}"
          "${APKSIGNER}" version

          mkdir -p dist

          detect_abi() {
            local f="$1"
            if echo "$f" | grep -q "arm64-v8a"; then echo "arm64-v8a"; return; fi
            if echo "$f" | grep -q "armeabi-v7a"; then echo "armeabi-v7a"; return; fi
            if echo "$f" | grep -q "x86_64"; then echo "x86_64"; return; fi
            if echo "$f" | grep -q "x86"; then echo "x86"; return; fi
            echo "unknown"
          }

          sign_one() {
            local in_apk="$1"
            local channel="$2"   # preview / oss
            local abi
            abi="$(detect_abi "$in_apk")"
            local out="dist/NekoBox-${UPSTREAM_TAG}-${channel}-${abi}-signed.apk"

            echo "Signing: $in_apk -> $out"
            "${APKSIGNER}" sign \
              --ks signing.p12 \
              --ks-type "${KSTORE_TYPE}" \
              --ks-pass "pass:${STOREPASS}" \
              --ks-key-alias "${ALIAS}" \
              --key-pass "pass:${KEYPASS}" \
              --out "${out}" \
              "${in_apk}"

            "${APKSIGNER}" verify --print-certs "${out}" >/dev/null
          }

          SIGNED_COUNT=0

          if [ -d "app/build/outputs/apk/preview/release" ]; then
            while IFS= read -r apk; do
              [ -f "$apk" ] || continue
              sign_one "$apk" "preview"
              SIGNED_COUNT=$((SIGNED_COUNT+1))
            done < <(find app/build/outputs/apk/preview/release -type f -name "*.apk" | sort)
          fi

          if [ -d "app/build/outputs/apk/oss/release" ]; then
            while IFS= read -r apk; do
              [ -f "$apk" ] || continue
              sign_one "$apk" "oss"
              SIGNED_COUNT=$((SIGNED_COUNT+1))
            done < <(find app/build/outputs/apk/oss/release -type f -name "*.apk" | sort)
          fi

          echo "Signed count = $SIGNED_COUNT"
          ls -lah dist || true
          test "$SIGNED_COUNT" -gt 0

      - name: Upload APKs (artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: APKs
          path: dist/*.apk

      - name: Create GitHub Release + upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          RELEASE_TAG="patched-${UPSTREAM_TAG}+build-${BUILD_TS}"
          RELEASE_TITLE="Patched ${UPSTREAM_TAG} (${BUILD_TS} CST)"

          printf "Upstream: %s\nPatched branch: patched-release\nCommit: %s\n\nArtifacts:\n- Preview (signed)\n- OSS Stable (signed)\n" \
            "${UPSTREAM_TAG}" "$(git rev-parse --short HEAD)" > release_notes.txt

          git tag -f "${RELEASE_TAG}"
          git push origin -f "${RELEASE_TAG}"

          gh release create "${RELEASE_TAG}" dist/*.apk \
            --title "${RELEASE_TITLE}" \
            --notes-file release_notes.txt \
            --latest
