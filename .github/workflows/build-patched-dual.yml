name: Build Patched (Preview + Signed Release)

on:
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream release tag (e.g. 1.4.1). Leave empty for manual build."
        required: false
        default: ""

permissions:
  contents: write
  actions: write

env:
  TZ: Asia/Shanghai
  BUILD_PLUGIN: none

jobs:
  libcore:
    name: Native Build (LibCore)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release

      - name: Golang Status
        run: find buildScript libcore/*.sh | xargs cat | sha1sum > golang_status

      - name: Libcore Status
        run: git ls-files libcore | xargs cat | sha1sum > libcore_status

      - name: Restore LibCore Cache
        id: libcore_cache
        uses: actions/cache@v4
        with:
          path: app/libs/libcore.aar
          key: libcore-${{ runner.os }}-${{ hashFiles('golang_status', 'libcore_status', '.github/workflows/**') }}
          restore-keys: |
            libcore-${{ runner.os }}-

      - name: Install Golang
        if: steps.libcore_cache.outputs.cache-hit != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25

      - name: Native Build
        if: steps.libcore_cache.outputs.cache-hit != 'true'
        run: ./run lib core

  build:
    name: Build Preview + Signed Release
    runs-on: ubuntu-latest
    needs: [libcore]
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release

      - name: Restore LibCore Cache
        uses: actions/cache@v4
        with:
          path: app/libs/libcore.aar
          key: libcore-${{ runner.os }}-${{ hashFiles('golang_status', 'libcore_status', '.github/workflows/**') }}
          restore-keys: |
            libcore-${{ runner.os }}-

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', '**/gradle.properties', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Init Gradle
        run: |
          set -e
          echo "sdk.dir=${ANDROID_HOME}" > local.properties
          echo "ndk.dir=${ANDROID_HOME}/ndk/25.0.8775105" >> local.properties
          ./run init action gradle

      # 1) Preview Debug：用来测试，自动可安装（debug key），放 artifact
      - name: Build Preview Debug (artifact)
        run: |
          set -e
          ./gradlew app:assemblePreviewDebug
          APK_DIR=$(dirname "$(find app/build/outputs/apk -type f -name "*arm64-v8a*.apk" | head -n 1)")
          echo "PREVIEW_APK_DIR=$APK_DIR" >> $GITHUB_ENV

      - name: Upload Preview APKs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: Preview-APKs
          path: ${{ env.PREVIEW_APK_DIR }}

      # 2) Stable Release：用你 secrets 的 keystore 签名，发布到 GitHub Releases
      - name: Prepare signing keystore
        run: |
          set -e
          echo "${{ secrets.SIGNING_P12_B64 }}" | base64 -d > signing.p12
          ls -l signing.p12

      - name: Build Stable Release (signed)
        run: |
          set -e

          # 尽量兼容不同 task 名称（有些仓库是 assembleRelease，有些是 assembleOssRelease）
          TASK="app:assembleRelease"
          ./gradlew -q tasks --all | grep -q "assembleOssRelease" && TASK="app:assembleOssRelease"
          echo "Using task: $TASK"

          ./gradlew "$TASK" \
            -Pandroid.injected.signing.store.file="$PWD/signing.p12" \
            -Pandroid.injected.signing.store.password="${{ secrets.SIGNING_STORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ secrets.SIGNING_KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ secrets.SIGNING_KEY_PASSWORD }}"

          REL_APK_DIR=$(dirname "$(find app/build/outputs/apk -type f -name "*-release*.apk" | head -n 1)")
          echo "RELEASE_APK_DIR=$REL_APK_DIR" >> $GITHUB_ENV

      - name: Decide release tag/name
        id: rel
        run: |
          set -e
          UP="${{ inputs.upstream_tag }}"
          if [ -z "$UP" ]; then
            UP="manual"
          fi
          TS=$(date +'%Y%m%d-%H%M')
          echo "tag=patched-${UP}+build-${TS}" >> $GITHUB_OUTPUT
          echo "name=patched-${UP} (${TS} Asia/Shanghai)" >> $GITHUB_OUTPUT

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          name: ${{ steps.rel.outputs.name }}
          prerelease: false
          files: |
            ${{ env.RELEASE_APK_DIR }}/*.apk
