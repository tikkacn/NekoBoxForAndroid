name: Build Patched Release (Debug APK)

on:
  workflow_dispatch:

permissions:
  contents: write   # ✅ 允许创建 GitHub Release / 上传附件
  actions: read

jobs:
  libcore:
    name: Native Build (LibCore)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release

      - name: Golang Status
        run: find buildScript libcore/*.sh | xargs cat | sha1sum > golang_status

      - name: Libcore Status
        run: git ls-files libcore | xargs cat | sha1sum > libcore_status

      - name: LibCore Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            app/libs/libcore.aar
          key: ${{ hashFiles('.github/workflows/*', 'golang_status', 'libcore_status') }}

      - name: Install Golang
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ^1.25

      - name: Native Build
        if: steps.cache.outputs.cache-hit != 'true'
        run: ./run lib core

  build:
    name: Build APK + Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - libcore
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Golang Status
        run: find buildScript libcore/*.sh | xargs cat | sha1sum > golang_status

      - name: Libcore Status
        run: git ls-files libcore | xargs cat | sha1sum > libcore_status

      - name: LibCore Cache
        uses: actions/cache@v4
        with:
          path: |
            app/libs/libcore.aar
          key: ${{ hashFiles('.github/workflows/*', 'golang_status', 'libcore_status') }}

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle
          key: gradle-oss-${{ hashFiles('**/*.gradle.kts') }}

      # ✅ 关键：自动补齐 VERSION_GEOIP，避免 ./run init action gradle 里 curl 404
      - name: Resolve VERSION_GEOIP (fallback)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if [ -n "${VERSION_GEOIP:-}" ]; then
            echo "VERSION_GEOIP already set: $VERSION_GEOIP"
            exit 0
          fi

          SCRIPT="buildScript/init/action/gradle.sh"
          if [ ! -f "$SCRIPT" ]; then
            echo "No $SCRIPT, skip resolving VERSION_GEOIP"
            exit 0
          fi

          OWNERREPO=$(grep -oE 'https://github\.com/[^/]+/[^/]+/releases/download/\$\{?VERSION_GEOIP\}?' "$SCRIPT" \
            | head -n 1 \
            | sed -E 's#https://github\.com/([^/]+/[^/]+)/releases/download/.*#\1#' || true)

          if [ -z "$OWNERREPO" ]; then
            OWNERREPO=$(grep -oE 'github\.com/[^/]+/[^/]+/releases/download/\$\{?VERSION_GEOIP\}?' "$SCRIPT" \
              | head -n 1 \
              | sed -E 's#.*github\.com/([^/]+/[^/]+)/releases/download/.*#\1#' || true)
          fi

          echo "Detected geoip release repo: ${OWNERREPO:-<none>}"
          if [ -z "$OWNERREPO" ]; then
            echo "Could not detect geoip repo; leaving VERSION_GEOIP empty"
            exit 0
          fi

          TAG=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/$OWNERREPO/releases/latest" \
            | jq -r .tag_name)

          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "Failed to resolve latest release tag for $OWNERREPO"
            exit 1
          fi

          echo "Resolved VERSION_GEOIP=$TAG"
          echo "VERSION_GEOIP=$TAG" >> $GITHUB_ENV

      - name: Gradle Build (Preview Debug, installable)
        env:
          BUILD_PLUGIN: none
        run: |
          set -e
          echo "sdk.dir=${ANDROID_HOME}" > local.properties
          echo "ndk.dir=${ANDROID_HOME}/ndk/25.0.8775105" >> local.properties
          export LOCAL_PROPERTIES="${{ secrets.LOCAL_PROPERTIES }}"

          ./run init action gradle
          ./gradlew app:assemblePreviewDebug

          mkdir -p dist
          # 尽量把所有 apk 都收集起来（arm64/通用等）
          find app/build/outputs/apk -type f -name "*.apk" -maxdepth 6 -print -exec cp -f {} dist/ \;

          echo "Dist files:"
          ls -lah dist || true

      - name: Prepare Release Info
        id: rel
        run: |
          set -e
          UPSTREAM_TAG=""
          if [ -f .upstream_release_tag ]; then
            UPSTREAM_TAG="$(cat .upstream_release_tag | tr -d '\r\n')"
          fi
          if [ -z "$UPSTREAM_TAG" ]; then
            # 兜底：用 git describe（不一定有 tag，但尽量给个值）
            UPSTREAM_TAG="$(git describe --tags --always | tr -d '\r\n')"
          fi

          RELEASE_TAG="patched-${UPSTREAM_TAG}"
          RELEASE_NAME="Patched ${UPSTREAM_TAG}"
          BODY=$'Built from upstream release tag: '"${UPSTREAM_TAG}"$'\n\nPatches:\n- Hide menu: 文档/推广\n- Remove donate item from About\n'

          echo "UPSTREAM_TAG=$UPSTREAM_TAG" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

          # 输出给后续步骤
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          # Release 说明写到文件，给 action-gh-release 用
          printf "%s" "$BODY" > release_notes.txt

      # ✅ 发布到 GitHub Releases（创建或更新同名 tag 的 Release，并上传 dist/*.apk）
      - name: Publish GitHub Release (attach APKs)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release_notes.txt
          target_commitish: patched-release
          files: |
            dist/*.apk
          fail_on_unmatched_files: true
          make_latest: false

      # 仍然保留 Artifacts（方便你在 Actions 里直接下载）
      - name: Upload APKs (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: APKs
          path: dist
