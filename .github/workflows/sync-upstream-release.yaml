name: Sync Upstream Release (apply UI patches)

on:
  workflow_dispatch:
  schedule:
    # 每6小时检查一次上游是否发了新 Release；没更新就快速退出，不会浪费编译时间
    - cron: "0 */6 * * *"

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Git config
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Read upstream latest release tag
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG=$(curl -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/MatsuriDayo/NekoBoxForAndroid/releases/latest \
            | jq -r .tag_name)

          if [ -z "${TAG}" ] || [ "${TAG}" = "null" ]; then
            echo "Failed to get upstream tag_name."
            exit 1
          fi
          echo "UPSTREAM_TAG=${TAG}" >> "${GITHUB_ENV}"
          echo "Upstream latest tag: ${TAG}"

      - name: Read current synced tag (from patched-release)
        id: current
        run: |
          set -euo pipefail
          CUR=""
          if [ -f .upstream_release_tag ]; then
            CUR=$(cat .upstream_release_tag | tr -d '\r\n\t ')
          fi
          echo "CURRENT_TAG=${CUR}" >> "${GITHUB_ENV}"
          echo "Current synced tag: ${CUR}"

      - name: Compare tags (gate)
        id: compare
        run: |
          set -euo pipefail
          if [ "${UPSTREAM_TAG}" = "${CURRENT_TAG}" ]; then
            echo "updated=false" >> "${GITHUB_OUTPUT}"
            echo "No upstream update. Exit."
          else
            echo "updated=true" >> "${GITHUB_OUTPUT}"
            echo "Upstream updated: ${CURRENT_TAG} -> ${UPSTREAM_TAG}"
          fi

      - name: Backup workflows (keep ours)
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          mkdir -p /tmp/keep_workflows
          if [ -d .github/workflows ]; then
            tar -czf /tmp/keep_workflows/workflows.tgz .github/workflows
            echo "Backed up .github/workflows"
          else
            echo "No .github/workflows to backup"
          fi

      - name: Add upstream remote & fetch tags
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/MatsuriDayo/NekoBoxForAndroid.git
          git fetch upstream --tags --force

      - name: Sync upstream tag -> patched-release (hard reset), then restore workflows
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          git reset --hard "refs/tags/${UPSTREAM_TAG}"

          if [ -f /tmp/keep_workflows/workflows.tgz ]; then
            rm -rf .github/workflows || true
            tar -xzf /tmp/keep_workflows/workflows.tgz
            echo "Restored .github/workflows"
          fi

      - name: Apply UI patches (About donate + hide nav items + remove handlers)
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import os, re

          def read(path):
            with open(path, "r", encoding="utf-8") as f:
              return f.read()

          def write(path, s):
            with open(path, "w", encoding="utf-8") as f:
              f.write(s)

          def warn(msg): print("[WARN]", msg)
          def ok(msg): print("[OK]", msg)

          # -------- Patch 1: AboutFragment remove donate item --------
          about_path = "app/src/main/java/io/nekohasekai/sagernet/ui/AboutFragment.kt"
          if os.path.exists(about_path):
            s = read(about_path)

            pattern = re.compile(
              r"""\.addItem\(\s*MaterialAboutActionItem\.Builder\(\)\s*
                  (?:.|\n)*?\.text\(\s*R\.string\.donate\s*\)\s*
                  (?:.|\n)*?\.build\(\)\s*\)\s*""",
              re.X
            )
            s2, n = pattern.subn("", s, count=1)

            if n == 0:
              pattern2 = re.compile(
                r"""\.addItem\(\s*
                    (?:.|\n)*?R\.string\.donate
                    (?:.|\n)*?\.build\(\)\s*\)\s*""",
                re.X
              )
              s2, n = pattern2.subn("", s, count=1)

            if n > 0:
              write(about_path, s2)
              ok("Remove donate item in AboutFragment")
            else:
              warn(f"Remove donate item in AboutFragment: pattern not found, skip ({about_path})")
          else:
            warn(f"AboutFragment not found: {about_path}")

          # -------- Patch 2: Hide drawer menu items --------
          menu_path = "app/src/main/res/menu/main_drawer_menu.xml"
          if os.path.exists(menu_path):
            s = read(menu_path)

            def hide_item(xml: str, item_id: str):
              pat = re.compile(rf'(<item\b[^>]*\bandroid:id="@\+id/{re.escape(item_id)}"[^>]*)(/?>)', re.M)
              m = pat.search(xml)
              if not m:
                return xml, False, f"not found ({item_id})"
              head, tail = m.group(1), m.group(2)

              if 'android:visible=' in head:
                head2 = re.sub(r'android:visible="[^"]*"', 'android:visible="false"', head)
              else:
                head2 = head + '\n            android:visible="false"'
              xml2 = xml[:m.start()] + head2 + tail + xml[m.end():]
              return xml2, True, "ok"

            changed_any = False
            for item in ("nav_tuiguang", "nav_faq"):
              s2, changed, msg = hide_item(s, item)
              if changed:
                s = s2
                changed_any = True
                ok(f'Hide {item} in {menu_path}')
              else:
                warn(f'Hide {item} in {menu_path}: {msg}, skip')

            if changed_any:
              write(menu_path, s)
          else:
            warn(f"Drawer menu xml not found: {menu_path}")

          # -------- Patch 3: MainActivity remove handlers + force hide --------
          main_path = "app/src/main/java/io/nekohasekai/sagernet/ui/MainActivity.kt"
          if os.path.exists(main_path):
            s = read(main_path)
            orig = s

            s, _ = re.subn(
              r'(navigation\.menu\.findItem\(R\.id\.nav_tuiguang\)\?\.(?:isVisible|setVisible)\s*=\s*).*$',
              r'\1false',
              s,
              flags=re.M
            )

            if "findItem(R.id.nav_faq)?.isVisible" not in s:
              pat_insert = re.compile(r'(navigation\.menu\.findItem\(R\.id\.nav_tuiguang\)\?\.(?:isVisible|setVisible)\s*=\s*false\s*\n)')
              if pat_insert.search(s):
                s = pat_insert.sub(r'\1        navigation.menu.findItem(R.id.nav_faq)?.isVisible = false\n', s, count=1)
                ok("Add hide line for nav_faq")
              else:
                warn("Could not find nav_tuiguang hide line to insert nav_faq hide; skip insert")

            def remove_when_case(code: str, case_id: str):
              key = f"R.id.{case_id} -> {{"
              idx = code.find(key)
              if idx == -1:
                return code, False
              i = idx + len(key)
              depth = 1
              while i < len(code) and depth > 0:
                if code[i] == "{":
                  depth += 1
                elif code[i] == "}":
                  depth -= 1
                i += 1
              j = i
              while j < len(code) and code[j] in " \t\r\n":
                j += 1
              line_start = code.rfind("\n", 0, idx)
              start = line_start + 1 if line_start != -1 else idx
              return code[:start] + code[j:], True

            s, rm1 = remove_when_case(s, "nav_faq")
            ok("Remove nav_faq handler block") if rm1 else warn("Remove nav_faq handler block: not found, skip")

            s, rm2 = remove_when_case(s, "nav_tuiguang")
            ok("Remove nav_tuiguang handler block") if rm2 else warn("Remove nav_tuiguang handler block: not found, skip")

            if s != orig:
              write(main_path, s)
          else:
            warn(f"MainActivity not found: {main_path}")
          PY

      - name: Record synced tag
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          echo "${UPSTREAM_TAG}" > .upstream_release_tag

      - name: Commit changes (if any)
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Sync upstream release ${UPSTREAM_TAG} + apply UI patches"

      - name: Push patched-release
        if: steps.compare.outputs.updated == 'true'
        run: |
          set -euo pipefail
          git push origin HEAD:patched-release --force-with-lease

      - name: Trigger build workflow (only when updated)
        if: steps.compare.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # 触发你仓库里的 build-patched-dual.yml（ref 固定 patched-release）
          curl -fsSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-patched-dual.yml/dispatches \
            -d "{\"ref\":\"patched-release\"}" >/dev/null
          echo "Build workflow dispatched."
