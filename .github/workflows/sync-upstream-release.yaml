name: Sync Upstream Release (Only When Updated)

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force re-sync & re-apply patches even if tag unchanged"
        required: false
        default: "false"
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout patched-release
        uses: actions/checkout@v4
        with:
          ref: patched-release
          fetch-depth: 0

      - name: Get upstream latest release tag
        id: upstream
        run: |
          set -e
          TAG=$(curl -s https://api.github.com/repos/MatsuriDayo/NekoBoxForAndroid/releases/latest | jq -r .tag_name)
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Upstream latest tag: $TAG"

      - name: Read current synced tag (from patched-release)
        id: current
        run: |
          set -e
          if [ -f .upstream_release_tag ]; then
            CUR=$(cat .upstream_release_tag)
          else
            CUR=""
          fi
          echo "tag=$CUR" >> $GITHUB_OUTPUT
          echo "Current tag: $CUR"

      - name: Exit if no update
        if: steps.upstream.outputs.tag == steps.current.outputs.tag && inputs.force != 'true'
        run: echo "No new upstream release tag. Skip sync & build."

      - name: Sync upstream tag -> patched-release, then apply UI changes
        if: steps.upstream.outputs.tag != steps.current.outputs.tag || inputs.force == 'true'
        run: |
          set -e

          git remote add upstream https://github.com/MatsuriDayo/NekoBoxForAndroid.git || true
          git fetch upstream --tags --force

          TAG="${{ steps.upstream.outputs.tag }}"
          echo "Syncing to tag: $TAG"

          git reset --hard "refs/tags/$TAG"

          python3 - <<'PY'
          import re
          from pathlib import Path

          def read(p: Path) -> str:
              return p.read_text(encoding="utf-8")

          def write(p: Path, s: str):
              p.write_text(s, encoding="utf-8")

          def remove_additem_block_containing(p: Path, needle: str, desc: str):
              s = read(p)
              i = s.find(needle)
              if i == -1:
                  raise SystemExit(f"[FAIL] {desc}: needle not found: {needle} in {p}")

              call = s.rfind("addItem(", 0, i)
              if call == -1:
                  raise SystemExit(f"[FAIL] {desc}: addItem( not found before needle in {p}")

              line_start = s.rfind("\n", 0, call)
              line_start = 0 if line_start == -1 else line_start + 1

              open_idx = s.find("(", call)
              depth = 0
              end = None
              for j in range(open_idx, len(s)):
                  c = s[j]
                  if c == "(":
                      depth += 1
                  elif c == ")":
                      depth -= 1
                      if depth == 0:
                          end = j + 1
                          break
              if end is None:
                  raise SystemExit(f"[FAIL] {desc}: cannot find matching ')' for addItem( in {p}")

              new = s[:line_start] + s[end:]
              write(p, new)
              print(f"[OK] {desc}")

          def hide_menu_items_by_id(menu_dir: Path, item_ids: list[str]):
              if not menu_dir.exists():
                  print(f"[WARN] menu dir not found: {menu_dir}")
                  return

              for item_id in item_ids:
                  found_any = False
                  for xml in menu_dir.rglob("*.xml"):
                      s = read(xml)

                      def repl(m):
                          nonlocal found_any
                          tag = m.group(0)
                          if "android:visible=" in tag:
                              found_any = True
                              return tag
                          found_any = True
                          return tag.replace("<item", '<item android:visible="false"', 1)

                      new = re.sub(
                          rf"<item\b[^>]*android:id=\"@\+id/{re.escape(item_id)}\"[^>]*?/?>",
                          repl,
                          s,
                          flags=re.S,
                      )
                      if new != s:
                          write(xml, new)
                          print(f"[OK] Hide {item_id} in {xml}")

                  if not found_any:
                      print(f"[WARN] Menu item id not found anywhere: {item_id}")

          def force_disable_nav_tuiguang_in_mainactivity(p: Path):
              s = read(p)
              old = "navigation.menu.findItem(R.id.nav_tuiguang)?.isVisible = !isPlay"
              new = "navigation.menu.findItem(R.id.nav_tuiguang)?.isVisible = false"
              if old in s:
                  write(p, s.replace(old, new))
                  print("[OK] Force nav_tuiguang visibility to false in MainActivity")
                  return

              # 兜底：允许不同空格/换行写法
              pat = r'navigation\.menu\.findItem\(R\.id\.nav_tuiguang\)\?\.\s*isVisible\s*=\s*!isPlay'
              s2, n = re.subn(pat, new, s)
              if n > 0:
                  write(p, s2)
                  print("[OK] Force nav_tuiguang visibility to false in MainActivity (regex)")
              else:
                  print("[WARN] MainActivity nav_tuiguang visibility line not found; skip")

          # 1) About：删 donate
          about = Path("app/src/main/java/io/nekohasekai/sagernet/ui/AboutFragment.kt")
          remove_additem_block_containing(about, "R.string.donate", "Remove donate item in AboutFragment")

          # 2) menu：隐藏推广/文档
          menu_dir = Path("app/src/main/res/menu")
          hide_menu_items_by_id(menu_dir, ["nav_tuiguang", "nav_faq"])

          # 3) MainActivity：禁止运行时把“推广”强制显示出来
          main = Path("app/src/main/java/io/nekohasekai/sagernet/ui/MainActivity.kt")
          if main.exists():
              force_disable_nav_tuiguang_in_mainactivity(main)
          else:
              print("[WARN] MainActivity.kt not found, skip")

          # DEBUG：打印所有 menu item id
          try:
              ids = []
              for xml in menu_dir.rglob("*.xml"):
                  s = read(xml)
                  for m in re.finditer(r'android:id="@\+id/([^"]+)"', s):
                      ids.append((m.group(1), str(xml)))
              print("[DEBUG] menu item ids:")
              for item_id, xml in ids:
                  print(f"  - {item_id}  ({xml})")
          except Exception as e:
              print("[DEBUG] scan menu ids failed:", e)

          PY

          # patched-release 分支不要带 workflows
          rm -rf .github/workflows || true
          echo "$TAG" > .upstream_release_tag

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Sync upstream release $TAG + apply UI patches" || true
          git push --force-with-lease origin HEAD:patched-release

      - name: Trigger build workflow (only when updated)
        if: steps.upstream.outputs.tag != steps.current.outputs.tag || inputs.force == 'true'
        run: |
          set -e
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-patched-release.yml/dispatches \
            -d '{"ref":"main"}' >/dev/null
          echo "Build workflow dispatched."
